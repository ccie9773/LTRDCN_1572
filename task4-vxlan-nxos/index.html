<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Task 4 - Config switches using Ansible NXOS modules - Cisco Live LTRDCN-1572</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Task 4 - Config switches using Ansible NXOS modules";
    var mkdocs_page_input_path = "task4-vxlan-nxos.md";
    var mkdocs_page_url = "/task4-vxlan-nxos/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Cisco Live LTRDCN-1572</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../intro/">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task1-ansible-node/">Task 1 - Prepare Ansible node</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task2-first-ansible/">Task 2 - First Simple Ansible Playbook</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task3-vxlan-jinja2/">Task 3 - Use of Jinja2 templates with Ansible Playbook</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Task 4 - Config switches using Ansible NXOS modules</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#step-1-create-new-playbook">Step 1: Create new playbook</a></li>
    

    <li class="toctree-l2"><a href="#step-2-create-new-roles-and-vars">Step 2: Create new roles and vars</a></li>
    

    <li class="toctree-l2"><a href="#step-3-build-playbook-for-spine-role-tasks">Step 3: Build playbook for Spine role - tasks:</a></li>
    

    <li class="toctree-l2"><a href="#step-4-build-playbook-for-spine-role-vars">Step 4:  Build playbook for Spine role - vars</a></li>
    

    <li class="toctree-l2"><a href="#step-5-build-playbook-for-leaf-role-tasks">Step 5:  Build playbook for leaf role - tasks:</a></li>
    

    <li class="toctree-l2"><a href="#step-6-build-playbook-for-leaf-role-vars">Step 6: Build playbook for leaf role - vars</a></li>
    

    <li class="toctree-l2"><a href="#step-7-execute-playbook">Step 7: Execute playbook</a></li>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Cisco Live LTRDCN-1572</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Task 4 - Config switches using Ansible NXOS modules</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/fchaudhr/LTRDCN_1572/edit/master/docs/task4-vxlan-nxos.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>In this section, you will build remaining VXLAN fabric using Ansible NXOS modules.  We will configure BGP neighbors between spine and leaf switching by using Ansible NXOS modules. The following NXOS ansible modules are used:</p>
<table>
<thead>
<tr>
<th align="center">nxos_feature</th>
<th align="center">Manage features on Nexus switches</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">nxos_bgp</td>
<td align="center">Manage BGP config</td>
</tr>
<tr>
<td align="center">nxos_bgp_neighbor</td>
<td align="center">Manage BGP neighbor config</td>
</tr>
<tr>
<td align="center">Nxos_bgp_af</td>
<td align="center">Manage BGP address-famility config</td>
</tr>
<tr>
<td align="center">Nxos_bgp_neighbor_af</td>
<td align="center">Manage BGP neighbor address-famility config</td>
</tr>
</tbody>
</table>
<p>In comparison to Jinja2, NXOS modules are more abstract from configurations. There is no need to have knowledge of NXOS CLI to use NXOS modules. You will follow the steps to configure BGP, Multicast, VXLAN and EVPN. In each step, you will use different Ansible NXOS modules to accomplish the step. </p>
<p><img alt="" src="../pic/4-0-1.png" /></p>
<p>After each step, you can login the switches to verify configuration changes. </p>
<hr />
<h3 id="step-1-create-new-playbook">Step 1: Create new playbook</h3>
<p>Again we will use roles structure to make the playbook more modular.  The roles included in the new playbook are “<strong>spine</strong>” and “<strong>leaf</strong>”.  </p>
<ul>
<li>
<p>Switch to “Atom”, <strong>right click</strong> on the folder 'LTRDDCN-1572' and create a new playbook named <code>nxos_fabric.yml</code>. Enter this file name and hit enter</p>
</li>
<li>
<p>In the <code>nxos_fabric.yml</code> enter the content as shown in below screenshot:</p>
<p><img alt="" src="../pic/4-1-1.png" /></p>
</li>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </p>
</li>
</ul>
<hr />
<h3 id="step-2-create-new-roles-and-vars">Step 2: Create new roles and vars</h3>
<ul>
<li>
<p>On the MTputty, go back to Ansible Server node (198.18.134.150), switch to ‘<strong>roles</strong>’ directory; <strong>create</strong> ‘spine’ and ‘leaf’ roles using ansible-galaxy using below commands: </p>
<pre><code>[root@rhel7-tools LTRDCN-1572]# cd ~/LTRDCN-1572/roles/
[root@rhel7-tools roles]# ansible-galaxy init spine &amp;&amp; ansible-galaxy init leaf
</code></pre>
<p>Below screeshot shows the output of above command:</p>
<p><img alt="" src="../pic/4-2-1.png" /></p>
</li>
<li>
<p>Switch to “<strong>Atom</strong>” and sync the new created folders between Ansible node and Remote desktop by pressing <strong>Right Click</strong> on the folder <code>LTRDDCN-1572</code>, then open <code>Remote Sync</code> select <code>Download Folder</code> as shown below:</p>
<p><img alt="" src="../pic/4-2-2.png" /></p>
</li>
</ul>
<hr />
<h3 id="step-3-build-playbook-for-spine-role-tasks">Step 3: Build playbook for Spine role - tasks:</h3>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>tasks</strong>” folder.  We are going to use “<strong>Atom</strong>” to edit the <strong>main.yml</strong> file. </p>
<ul>
<li>On ATOM, open up the project folder <code>LTRDCN-1572</code> and edit <code>main.yml</code> file under <code>roles/spine/tasks/</code> to include following: </li>
</ul>
<pre><code class="YAML">---
# tasks file for spine
#task to configure bgp neighbor to all leaf switches
       - name: Enable BGP
         nxos_feature:
           feature: bgp
           provider: &quot;{{nxos_provider}}&quot;
           state: enabled
         tags: bgp
       - name: Configure BGP AS
         nxos_bgp:
           asn: &quot;{{ asn }}&quot;
           router_id: &quot;{{ router_id }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
           state: present
         tags: bgp
       - name: Configure BGP AF
         nxos_bgp_af:
           asn: &quot;{{ asn }}&quot;
           afi: ipv4
           safi: unicast
           provider: &quot;{{ nxos_provider }}&quot;
         tags: bgp
       - name: Configure iBGP neighbors
         nxos_bgp_neighbor:
           asn: &quot;{{ asn }}&quot;
           neighbor: &quot;{{ item.neighbor }}&quot;
           remote_as: &quot;{{ item.remote_as }}&quot;
           update_source: &quot;{{ item.update_source }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ bgp_neighbors }}&quot;
         tags: bgp
       - name: Configure iBGP neighbor AF
         nxos_bgp_neighbor_af:
           asn: &quot;{{ asn }}&quot;
           neighbor: &quot;{{ item.neighbor }}&quot;
           afi: ipv4
           safi: unicast
           route_reflector_client: &quot;true&quot;
           send_community: both
           provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ bgp_neighbors }}&quot;
         tags: bgp
</code></pre>

<p><strong>Note</strong>, in the above task/main.yml file multiple NXOS ansible modules have been used:</p>
<ul>
<li>
<p>“<strong>nxos_feature</strong>” module provides the capability to manage features in NX-OS features.  It is used to enable bgp as a feature in above configurations</p>
</li>
<li>
<p>“<strong>nxos_bgp</strong>” module provides the capability to manage BGP configuration in NX-OS.  Here it is used to configure bgp</p>
</li>
<li>
<p>“<strong>nxos_bgp_af</strong>” module provides the capability to manage BGP Address-family configuration in NX-OS.  </p>
</li>
<li>
<p>“<strong>nxos_bgp_neighbor</strong>” module is used to configure the BGP Neighbour in NX-OS.  </p>
</li>
<li>
<p>“<strong>nxos_bgp_neighbor_af</strong>” module provides the capability to manage BGP Address-family Neighbour configuration in NX-OS.  </p>
</li>
</ul>
<hr />
<h3 id="step-4-build-playbook-for-spine-role-vars">Step 4:  Build playbook for Spine role - vars</h3>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>vars</strong>” folder. We can use “<strong>Atom</strong>” to edit the main.yml file</p>
<ul>
<li>Switch to <strong>ATOM</strong>, then open up the project folder <code>LTRDCN-1572</code> from the left pane and <strong>open</strong> <code>main.yml</code> file under “<strong>roles/spine/vars/</strong>” and enter below content:</li>
</ul>
<pre><code class="YAML">---
# vars file for spine
  nxos_provider:
    username: &quot;{{ user }}&quot;
    password: &quot;{{ pwd }}&quot;
    transport: nxapi
    timeout: 30
    host: &quot;{{ inventory_hostname }}&quot;

  asn: 65000

  bgp_neighbors:
  - { remote_as: 65000, neighbor: 192.168.0.8, update_source: Loopback0 }
  - { remote_as: 65000, neighbor: 192.168.0.10, update_source: Loopback0 }
  - { remote_as: 65000, neighbor: 192.168.0.11, update_source: Loopback0 }
</code></pre>

<ul>
<li><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </li>
</ul>
<hr />
<h3 id="step-5-build-playbook-for-leaf-role-tasks">Step 5:  Build playbook for leaf role - tasks:</h3>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>tasks</strong>” folder. We can use “<strong>Atom</strong>” to edit the main.yml file</p>
<ul>
<li>On ATOM, open up the project folder <code>LTRDCN-1572</code> and edit <code>main.yml</code> file under <code>roles/leaf/tasks/</code> to include following: </li>
</ul>
<pre><code class="YAML">---
# tasks file for leaf
#task to configure bgp neighbor to all spine switches
       - name: Enable BGP
         nxos_feature:
           feature: bgp
           provider: &quot;{{nxos_provider}}&quot;
           state: enabled
         tags: bgp
       - name: Configure BGP AS
         nxos_bgp:
           asn: &quot;{{ asn }}&quot;
           router_id: &quot;{{ router_id }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
           state: present
         tags: bgp
       - name: Configure BGP AF
         nxos_bgp_af:
           asn: &quot;{{ asn }}&quot;
           afi: ipv4
           safi: unicast
           provider: &quot;{{ nxos_provider }}&quot;
         tags: bgp
       - name: Configure iBGP neighbors
         nxos_bgp_neighbor:
           asn: &quot;{{ asn }}&quot;
           neighbor: &quot;{{ item.neighbor }}&quot;
           remote_as: &quot;{{ item.remote_as }}&quot;
           update_source: &quot;{{ item.update_source }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ bgp_neighbors }}&quot;
         tags: bgp
       - name: Configure iBGP neighbor AF
         nxos_bgp_neighbor_af:
           asn: &quot;{{ asn }}&quot;
           neighbor: &quot;{{ item.neighbor }}&quot;
           afi: ipv4
           safi: unicast
           send_community: both
           provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ bgp_neighbors }}&quot;
         tags: bgp
</code></pre>

<ul>
<li><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </li>
</ul>
<hr />
<h3 id="step-6-build-playbook-for-leaf-role-vars">Step 6: Build playbook for leaf role - vars</h3>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>vars</strong>” folder. We can use “<strong>Atom</strong>” to edit the main.yml file</p>
<ul>
<li>Switch to <strong>ATOM</strong>, then open up the project folder <code>LTRDCN-1572</code> from the left pane and <strong>open</strong> <code>main.yml</code> file under “<strong>roles/leaf/vars/</strong>” and enter below content:</li>
</ul>
<pre><code class="YAML">---
# vars file for leaf
  nxos_provider:
    username: &quot;{{ user }}&quot;
    password: &quot;{{ pwd }}&quot;
    transport: nxapi
    timeout: 30
    host: &quot;{{ inventory_hostname }}&quot;

  asn: 65000

  bgp_neighbors:
  - { remote_as: 65000, neighbor: 192.168.0.6, update_source: Loopback0 }
  - { remote_as: 65000, neighbor: 192.168.0.7, update_source: Loopback0 }

</code></pre>

<ul>
<li><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </li>
</ul>
<hr />
<h3 id="step-7-execute-playbook">Step 7: Execute playbook</h3>
<ul>
<li>
<p>On the Ansible node (in MTputty SSH session), run the command (<code>ansible-playbook nxos_fabric.yml --tags "bgp"</code>) to execute the playbook as shown below:</p>
<pre><code>[root@rhel7-tools LTRDCN-1572]# cd ~/LTRDCN-1572
[root@rhel7-tools LTRDCN-1572]# ansible-playbook nxos_fabric.yml --tags "bgp"
</code></pre>
<p>Below screenshots shows the execution of above playbook:
<img alt="" src="../pic/4-3-1.png" />
<img alt="" src="../pic/4-3-2.png" />  </p>
</li>
<li>
<p>After the configuration push is successful, <strong>login</strong> (on MTputty SSH session) to <strong>leaf-1, leaf-3 or leaf-4</strong> or <strong>spine-1</strong> switch to verify configuration has been pushed by running below command and BGP neighbours are operational:</p>
<p><code>show ip bgp summary</code></p>
<p>the output of above command is shown below:</p>
<p><img alt="" src="../pic/4-3-3.png" />
<img alt="" src="../pic/4-3-4.png" /></p>
</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../task3-vxlan-jinja2/" class="btn btn-neutral" title="Task 3 - Use of Jinja2 templates with Ansible Playbook"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/fchaudhr/LTRDCN_1572/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../task3-vxlan-jinja2/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
