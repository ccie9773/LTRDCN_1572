<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Task 2 - First Simple Ansible Playbook - Cisco Live LTRDCN-1572</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Task 2 - First Simple Ansible Playbook";
    var mkdocs_page_input_path = "task2-first-ansible.md";
    var mkdocs_page_url = "/task2-first-ansible/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Cisco Live LTRDCN-1572</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../intro/">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task1-ansible-node/">Task 1 - Prepare Ansible node</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Task 2 - First Simple Ansible Playbook</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#task-2-first-simple-ansible-playbook">Task 2: First Simple Ansible Playbook</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#step-1-using-atom-text-editor">Step 1: Using "Atom" text Editor</a></li>
        
            <li><a class="toctree-l3" href="#step-2-atom-folder">Step 2: Atom folder</a></li>
        
            <li><a class="toctree-l3" href="#step-3-define-variables-tasks-for-playbook">Step 3: Define variables, tasks for playbook</a></li>
        
            <li><a class="toctree-l3" href="#step-4-vlan-tasks-in-playbook">Step 4: VLAN tasks in playbook</a></li>
        
            <li><a class="toctree-l3" href="#step-5-execute-playbook">Step 5: Execute playbook</a></li>
        
            <li><a class="toctree-l3" href="#step-6-server-port-vlan-tasks-in-playbook">Step 6: Server port VLAN tasks in playbook</a></li>
        
            <li><a class="toctree-l3" href="#step-7-execute-playbook">Step 7: Execute playbook</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Cisco Live LTRDCN-1572</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Task 2 - First Simple Ansible Playbook</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/fchaudhr/LTRDCN_1572/edit/master/docs/task2-first-ansible.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="task-2-first-simple-ansible-playbook">Task 2: First Simple Ansible Playbook</h1>
<p>In this section, we will create the first Ansible Playbook. In the playbook, we will configure VLANs on leaf switches, and assign VLANs to the server facing port. </p>
<p>You will learn create variables inside playbook, learn simple loop using “<strong>with_items</strong>”, learn simple logical using “<strong>when</strong>” and learn “<strong>tags</strong>” to isolate tasks from whole playbook. </p>
<hr />
<h3 id="step-1-using-atom-text-editor">Step 1: Using "Atom" text Editor</h3>
<ul>
<li>
<p>Open “Atom” text editor by double click the icon on desktop. Atom is the recommended text editor for this lab:</p>
<p><img alt="" src="../pic/2-1-atom.png" /></p>
</li>
<li>
<p>After opening ATOM, Click “No Never” to the “Register as default atom:// URI handlre” message as show below:</p>
<p><img alt="" src="../pic/2-1-2-atom.png" /></p>
</li>
</ul>
<hr />
<h3 id="step-2-atom-folder">Step 2: Atom folder</h3>
<ul>
<li>After opening ATOM, there should be a folder in the left pane named “LTRDCN-1572.”</li>
<li>
<p>Right click the pre-configured project folder ‘LTRDCN-1572’ and select <code>New File</code> </p>
<p><img alt="" src="../pic/2-2-atom-folder.png" /></p>
</li>
<li>
<p>Name the new file <code>vlan_provision.yml</code> and hit enter. This will creat the new file:</p>
<p><img alt="" src="../pic/2-2-2-atom-vlan.png" /></p>
</li>
</ul>
<hr />
<h3 id="step-3-define-variables-tasks-for-playbook">Step 3: Define variables, tasks for playbook</h3>
<p>In this step, we are going to define the scope, variable for playbook and tasks </p>
<ul>
<li>
<p>In the opened window for ‘vlan_provision.yml’ file, enter the below content. <strong>NOTE: YAML is space sensitive. Hence be careful with the spaces in below section. </strong></p>
<pre><code>---                     
#Task 2: Simple playbook assign VLAN to server facing port
  - hosts: leaf:jinja2_leaf
    vars:
      nxos_provider:
        username: "{{ user }}"
        password: "{{ pwd }}"
        transport: nxapi
        host: "{{ inventory_hostname }}"
</code></pre>
</li>
<li>
<p>“hosts” defines the scope of this playbook applies to all switches in group ‘leaf’ and ‘jinja2_leaf’. </p>
<ul>
<li>Note you can review the IP addresses of the three (2) “leaf” and one (1) “jinja2_leaf” in the “hosts” file (configured in previous steps).  The IP addresses are:<ul>
<li>jinja2_leaf: 198.18.4.104</li>
<li>leaf: 198.18.4.101</li>
<li>leaf: 198.18.4.103</li>
</ul>
</li>
</ul>
</li>
<li>“vars” defines one variable “nxos_provider” that will be used in this playbook. </li>
<li>“nxos_provider” is variable that includes all value that will be used for connection and autnentication. <ul>
<li>This variable will be referenced in playbook via “provider” argument.     </li>
</ul>
</li>
</ul>
<hr />
<h3 id="step-4-vlan-tasks-in-playbook">Step 4: VLAN tasks in playbook</h3>
<ul>
<li>
<p>Continue to add below tasks on the playbook:</p>
<pre><code>tasks:
  - name: provision VLAN
    nxos_config:
      lines: "vlan {{item}}"
      provider: "{{nxos_provider}}"
    with_items:
      -  140
      -  141
    tags: add vlans
</code></pre>
</li>
<li>
<p>Multiple plays can be defined in one playbook under“tasks”, each starts with “-“ . </p>
</li>
<li>This kind of play creates multiple VLANs using nxos_config module. <ul>
<li>The “lines” option is used to pass only one configuration command.  This commands must be the exact same commands as found in the device running-config.</li>
<li>Though one or multiple configuration commands can be configured under the “lines” option.   For multiple, ordered set of commands can be configured under this “line” section.</li>
</ul>
</li>
<li>
<p>At the end of this play, we use “tags” to name the play “add vlans”. This is useful to run a specific part of the configuration without running whole playbook. </p>
<p><img alt="" src="../pic/2-4-1.png" /></p>
<p><strong>NOTE: Formatting is extremely important when working with Ansible. Ansible playbook would return errors if the spaces are not properly aligned or formatting is not correct
</strong></p>
</li>
<li>
<p>Click “File” “Save” . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “remote-sync” package. </p>
<p><img alt="" src="../pic/2-4-2.png" /></p>
<p><strong>NOTE: Once the Save button is pressed, then at the lower part of ATOM app, you will see message about connecting to Ansibe host (198.18.134.150) and saving the vlan_provision.yml file</strong></p>
</li>
</ul>
<hr />
<h3 id="step-5-execute-playbook">Step 5: Execute playbook</h3>
<p>After creating the playbook, it is now time to execute the playbook. </p>
<ul>
<li>Before executing the playbook, we will verify the leaf switch if it has any vlan configuration present on it.</li>
<li>
<p><strong>Login</strong> to leaf-3 switch using the Mputty client, or any leaf switch and execute <code>show vlan brief</code> command. This will show us the vlans that currently exist on the leaf switch.  As you note from below screenshot only the default VLAN (vlan number 1) is configured:</p>
<p><img alt="" src="../pic/2-5-1.png" /></p>
</li>
<li>
<p>Now, go to mputty, login or launch a new ssh into Ansible node (198.18.134.150) </p>
</li>
<li>Use command <code>ansible-playbook vlan_provision.yml --tags "add vlans"</code> under folder "LTRDCN-1572" as shown below:<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook vlan_provision.yml --tags "add vlans"
</code></pre>
</li>
</ul>
<p><strong>Note:</strong></p>
<ul>
<li>If the playbook fails first time, re-run the playbook again. </li>
<li>
<p>Make sure to save all the changes in the playbook first before executing the playbook in Ansible</p>
<p><img alt="" src="../pic/2-5-2.png" /></p>
</li>
<li>
<p>After playbook is run successfully, login into leaf 3 again and check if vlan 140 and vlan 141 appears. There would also be a log message on the screen indicating a configuration change was pushed to the device
    <img alt="" src="../pic/2-5-3.png" /></p>
</li>
</ul>
<hr />
<h3 id="step-6-server-port-vlan-tasks-in-playbook">Step 6: Server port VLAN tasks in playbook</h3>
<p>Now, we have tested our first playbook with basic configuration ( adding 2 VLANS), we are now going to add more tasks in our existing playbook “vlan_provision.yml”</p>
<ul>
<li>we will add new plays in the playbook to assign VLANs to server facing port. This time, we will configure VLAN towards the server facing ports</li>
<li>Go back to ATOM and add the following plays to the existing playbook<pre><code>  - name: configure server facing port to L2
    nxos_interface:
      interface: eth1/3
      mode: layer2
      provider: "{{nxos_provider}}"
  - name: configure VLAN for server port
    when: ("101" in inventory_hostname) or ("103" in inventory_hostname)
    nxos_switchport:
      interface: eth1/3
      mode: access
      access_vlan: 140
      provider: "{{nxos_provider}}"
  - name: configure VLAN for server port
    when: ("102" in inventory_hostname) or ("104" in inventory_hostname)
    nxos_switchport:
      interface: eth1/3
      mode: access
      access_vlan: 141
      provider: "{{nxos_provider}}"
</code></pre>
</li>
</ul>
<p>In this new play, we used nxos module “<strong>nxos_interface</strong>” and “<strong>nxos_switchport</strong>”. </p>
<ul>
<li>“nxos_interface” provides the capability to manage the physical attributes of an interface<ul>
<li>In this example, it is used to configure “layer 2” on interface Ethernet 1/3</li>
</ul>
</li>
<li>“nxos_switchport” provides the capability to manage the Layer 2 switchport attributes<ul>
<li>In this example, it is used to configuration it is used to configure mode access on Ethernet ports 1/3</li>
</ul>
</li>
<li>We used “when” argument to provide little logic of the play. <ul>
<li>In our example, the playbook assign VLAN 140 on leaf1 and leaf3 switches; assign VLAN 141 on leaf2 and leaf4 switches. </li>
</ul>
</li>
<li>Click “<strong>File</strong>” and “<strong>Save</strong>” will save the playbook, and also ftp the playbook to Ansible server using pre-configured “remote-sync” package. </li>
</ul>
<hr />
<h3 id="step-7-execute-playbook">Step 7: Execute playbook</h3>
<p>Now, we are going to execute the playbook with the command <code>ansible-playbook vlan_provision.yml</code></p>
<ul>
<li>Open MTPuttY and log back into (or launch a new ssh) into “Ansible” node.</li>
<li>
<p>Execute command “ansible-playbook vlan_provision.yml” in the “LTRDCN-1572” directory as shown below:</p>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook vlan_provision.yml
</code></pre>
<p><img alt="" src="../pic/2-7-1.png" /></p>
</li>
<li>
<p>After we push the configuration, login to leaf-3 switch, and check if the server facing port has the access vlan configured with the below command:
  <code>show run interface ethernet1/3</code></p>
<p>The output of above command is shown in below screenshot:</p>
<p><img alt="" src="../pic/2-7-2.png" /></p>
</li>
</ul>
<hr />
<p><strong>Congratulation! You have created your first ansible playbook, automatically provisioned new VLANs and assigned port to new created VLANs using Ansible. Next we are going to create VXLAN Fabric using Ansible. 
</strong></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../task1-ansible-node/" class="btn btn-neutral" title="Task 1 - Prepare Ansible node"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/fchaudhr/LTRDCN_1572/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../task1-ansible-node/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
